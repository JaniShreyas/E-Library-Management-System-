<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='forms.css') }}">
    <style>
        .controlKey{
            position: fixed;
            top:0;
        }
    </style>
</head>

<body>
    <div class="flash">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        {% for message in messages %}
        {{message}} <br>
        {% endfor %}
        {% endif %}
        {% endwith %}
    </div>

    <div>
        <button id="prevButton" disabled="true" class="controlKey" style="left: 650px">Previous</button>
        <button id="nextButton" class="controlKey" style="left: 800px">Next</button>
        <p id="pageNumText" class="controlKey"></p>
        <p id="totalPages" class="controlKey"></p>
        <input type="number" id="pageNum" width="1px" onchange="updateAndRender()" class="controlKey" style="width: 50px;">
    </div>
    <div>
        <canvas id="pdf-canvas"></canvas>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <script type="module">
        var url = "{{url_for('static', filename=book.content)}}";
        // Loaded via <script> tag, create shortcut to access PDF.js exports.
        var { pdfjsLib } = globalThis;

        // The workerSrc property shall be specified.
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.mjs';

        // Asynchronous download of PDF
        var loadingTask = pdfjsLib.getDocument(url);
        var pdf = null;
        var pageNum = 1;

        loadingTask.promise.then(function (loadedPdf) {
            console.log('PDF loaded');

            // Fetch the first page
            pdf = loadedPdf;
            renderPage(pageNum);
            document.getElementById('totalPages').textContent = ' / ' + pdf.numPages;
            document.getElementById('prevButton').onclick = previousPage;
            document.getElementById('nextButton').onclick = nextPage;
            document.getElementById("pageNum").addEventListener("input", updateAndRender);
            document.getElementById("pageNumText").textContent = pageNum;
        }, function (reason) {
            // PDF loading error
            console.error(reason);
        });

        function renderPage(num) {

            pdf.getPage(num).then(function (page) {
                console.log('Page loaded');

                var scale = 1.5;
                var viewport = page.getViewport({ scale: scale });

                // Prepare canvas using PDF page dimensions
                // Create canvas
                var canvas = document.getElementById('pdf-canvas');
                var context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Append canvas to the body
                document.body.appendChild(canvas);

                // Render PDF page into canvas context
                var renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                var renderTask = page.render(renderContext);
                renderTask.promise.then(function () { });
            });

        }

        function updateButtons() {
            // if cannot go to next page, disable
                document.getElementById('nextButton').disabled = pageNum >= pdf.numPages;
                document.getElementById('prevButton').disabled = pageNum <= 1;
        }

        function updateAndRender() {

            var inputValue = parseInt(document.getElementById("pageNum").value);
            if (!isNaN(inputValue) && inputValue >= 0 && inputValue <= pdf.numPages) {
                // Call function only if the input is a valid number between 0 and length
                pageNum = inputValue;
                document.getElementById("pageNumText").textContent = pageNum;
                updateButtons();
                renderPage(inputValue);
            }
        }

        function nextPage() {
            if (pdf != null) {
                if (pageNum >= pdf.numPages) {
                    return;
                }
                pageNum++;
                updateButtons();
                document.getElementById("pageNum").value = pageNum;
                updateAndRender();
            }
        }

        function previousPage() {
            if (pdf != null) {
                if (pageNum <= 1) {
                    return;
                }
                pageNum--;
                updateButtons();
                document.getElementById("pageNum").value = pageNum;
                updateAndRender();
            }
        }

        function getInput(event) {
            console.log(event)
            if (event.keyCode == "37") {
                previousPage();
            }
            if (event.keyCode == "39") {
                nextPage();
            }
        }
        document.addEventListener("keydown", getInput)

    </script>

</body>

</html>